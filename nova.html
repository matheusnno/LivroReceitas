<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Nova Receita</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1 id="formTitle">Nova Receita</h1>
  <form id="formReceita">
    <label>Nome: <input type="text" name="nome" required></label><br>
    <label>Categoria: <input type="text" name="categoria"></label><br>
    <label>Tempo de Preparo: <input type="text" name="tempo_preparo"></label><br>
    <label>Rendimento: <input type="text" name="rendimento"></label><br>
    <label>Modo de Preparo:<br>
      <textarea name="modo_preparo"></textarea>
    </label><br>

    <h3>Ingredientes</h3>
    <div id="ingredientes"></div>
    <button type="button" onclick="addIng()">Adicionar Ingrediente</button><br><br>

    <button type="submit">Salvar</button>
  </form>

  <script src="app.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const receitaId = urlParams.get('id');
    const ingContainer = document.getElementById('ingredientes');

    function addIng(nome = '', qtde = '') {
      const div = document.createElement('div');
      div.innerHTML = `
        <input type="text" name="ing_nome" placeholder="Ingrediente" value="${nome}">
        <input type="text" name="ing_qtde" placeholder="Quantidade" value="${qtde}">
        <button type="button" onclick="this.parentElement.remove()">X</button>
      `;
      ingContainer.appendChild(div);
    }

    async function carregarReceita() {
      if (!receitaId) return;
      const r = await api.obterReceita(receitaId);
      if (!r) return;

      document.getElementById('formTitle').textContent = 'Editar Receita';

      const form = document.getElementById('formReceita');
      form.nome.value = r.nome;
      form.categoria.value = r.categoria || '';
      form.tempo_preparo.value = r.tempo_preparo || '';
      form.rendimento.value = r.rendimento || '';
      form.modo_preparo.value = r.modo_preparo || '';

      // usa os ingredientes vindos junto da receita
      ingContainer.innerHTML = '';
      (r.ingrediente || []).forEach(i => addIng(i.nome, i.qtde || ''));
    }

    document.getElementById('formReceita').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const receita = {
        nome: form.nome.value,
        categoria: form.categoria.value,
        tempo_preparo: form.tempo_preparo.value,
        rendimento: form.rendimento.value,
        modo_preparo: form.modo_preparo.value
      };

      const ingredientes = Array.from(ingContainer.children).map(div => {
        return {
          nome: div.querySelector('[name=ing_nome]').value,
          qtde: div.querySelector('[name=ing_qtde]').value
        };
      });

      if (receitaId) {
        await api.atualizarReceitaCompleta(receitaId, receita, ingredientes);
      } else {
        await api.criarReceitaCompleta(receita, ingredientes);
      }

      window.location.href = 'index.html';
    });

    carregarReceita();
  </script>
</body>
</html>
